import{e as u,R as v,d as C,M as w,W as b,l as p}from"./index-675b8cbc.js";class m{constructor(t,s,l){this._languageId=t,this._worker=s,this._defaults=l,this._disposables=[],this._listener=Object.create(null);const i=e=>{let n=e.getLanguageId();n===this._languageId&&(this._listener[e.uri.toString()]=e.onDidChangeContent(C(()=>{this._doValidate(e.uri,n)},500)),this._doValidate(e.uri,n))},r=e=>{u.setModelMarkers(e,this._languageId,[]);let n=e.uri.toString(),d=this._listener[n];d&&(d.dispose(),delete this._listener[n])};this._disposables.push(u.onDidCreateModel(i)),this._disposables.push(u.onWillDisposeModel(r)),this._disposables.push(u.onDidChangeModelLanguage(e=>{r(e.model),i(e.model)})),this._disposables.push(this._defaults.onDidChange(e=>{u.getModels().forEach(n=>{n.getLanguageId()===this._languageId&&(r(n),i(n))})})),this._disposables.push({dispose:()=>{for(let e in this._listener)this._listener[e].dispose()}}),u.getModels().forEach(i)}dispose(){this._disposables.forEach(t=>t&&t.dispose()),this._disposables=[]}_doValidate(t,s){this._worker(t).then(l=>{var i;let r=((i=u.getModel(t))===null||i===void 0?void 0:i.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(r=this._defaults.preprocessCode(r)),l.doValidation(r)}).then(l=>{const i=l.map(e=>M(t,e));let r=u.getModel(t);r&&r.getLanguageId()===s&&u.setModelMarkers(r,s,i)}).then(void 0,l=>{console.error(l)})}}function A(o){switch(o){default:return w.Error}}function M(o,t){return{severity:A(),startLineNumber:t.startLine,startColumn:t.startColumn,endLineNumber:t.endLine,endColumn:t.endColumn,message:t.message,code:void 0,source:"dt-sql-parser"}}class k{constructor(t,s){this._worker=t,this._defaults=s}get triggerCharacters(){return Array.isArray(this._defaults.triggerCharacters)?this._defaults.triggerCharacters:["."," "]}provideCompletionItems(t,s,l,i){const r=t.uri;return this._worker(r).then(e=>{var n;let d=((n=u.getModel(r))===null||n===void 0?void 0:n.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(d=this._defaults.preprocessCode(d)),e.doCompletionWithEntities(d,s)}).then(([e,n])=>this._defaults.completionService(t,s,l,e,n)).then(e=>{const n=t.getWordUntilPosition(s),d=new v(s.lineNumber,n.startColumn,s.lineNumber,n.endColumn);return{suggestions:(Array.isArray(e)?e:e.suggestions).map(h=>{var g,c;return Object.assign(Object.assign({},h),{insertText:(g=h.insertText)!==null&&g!==void 0?g:typeof h.label=="string"?h.label:h.label.label,range:(c=h.range)!==null&&c!==void 0?c:d})}),dispose:Array.isArray(e)?void 0:e.dispose,incomplete:Array.isArray(e)?void 0:e.incomplete}})}}class I{constructor(t){this._worker=t}provideDefinition(t,s){const l=t.uri;return t.getLineContent(s.lineNumber).startsWith("--")?null:this._worker(l).then(r=>r.getAllEntities(t.getValue())).then(r=>{const e=t.getWordAtPosition(s);let n={line:-1,startIndex:-1,endIndex:-1,startColumn:-1,endColumn:-1};if(r==null||r.forEach(d=>{d.entityContextType.includes("Create")&&(e!=null&&e.word)&&d.text===(e==null?void 0:e.word)&&(n=d.position)}),n&&n.line!==-1)return{uri:t.uri,range:new v(n==null?void 0:n.line,n==null?void 0:n.startColumn,n==null?void 0:n.line,n==null?void 0:n.endColumn)}})}}class y{constructor(t){this._worker=t}provideReferences(t,s){const l=t.uri;return t.getLineContent(s.lineNumber).startsWith("CREATE")?this._worker(l).then(r=>r.getAllEntities(t.getValue())).then(r=>{const e=t.getWordAtPosition(s),n=[];return r==null||r.forEach(d=>{if(e!=null&&e.word&&d.text===(e==null?void 0:e.word)){let a=null;a=d.position,n.push({uri:t.uri,range:new v(a==null?void 0:a.line,a==null?void 0:a.startColumn,a==null?void 0:a.line,a==null?void 0:a.endColumn)})}}),n.length?n:null}):null}}function E(o){const t=[],s=[],l=new b(o);t.push(l);const i=(...e)=>l.getLanguageServiceWorker(...e);function r(){const{languageId:e,modeConfiguration:n}=o;_(s),n.diagnostics&&s.push(new m(e,i,o)),n.completionItems.enable&&s.push(p.registerCompletionItemProvider(e,new k(i,o))),s.push(p.registerDefinitionProvider(e,new I(i))),s.push(p.registerReferenceProvider(e,new y(i)))}return r(),t.push(f(s)),f(t)}function f(o){return{dispose:()=>_(o)}}function _(o){for(var t;o.length;)(t=o.pop())===null||t===void 0||t.dispose()}export{E as setupLanguageMode};
