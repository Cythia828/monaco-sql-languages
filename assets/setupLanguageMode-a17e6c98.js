import{e as a,R as v,M as w,W as b,l as f}from"./index-9c67c19f.js";function k(s,e,i){let o=null;return(...l)=>{if(o&&clearTimeout(o),i&&!o)return s==null?void 0:s(...l);o=setTimeout(()=>{o&&clearTimeout(o),o=null,s==null||s(...l)},e)}}class A{constructor(e,i,o){this._languageId=e,this._worker=i,this._defaults=o,this._disposables=[],this._listener=Object.create(null);const l=t=>{let r=t.getLanguageId();r===this._languageId&&(this._listener[t.uri.toString()]=t.onDidChangeContent(k(()=>{this._doValidate(t.uri,r)},500)),this._doValidate(t.uri,r))},u=t=>{a.setModelMarkers(t,this._languageId,[]);let r=t.uri.toString(),n=this._listener[r];n&&(n.dispose(),delete this._listener[r])};this._disposables.push(a.onDidCreateModel(l)),this._disposables.push(a.onWillDisposeModel(u)),this._disposables.push(a.onDidChangeModelLanguage(t=>{u(t.model),l(t.model)})),this._disposables.push(this._defaults.onDidChange(t=>{a.getModels().forEach(r=>{r.getLanguageId()===this._languageId&&(u(r),l(r))})})),this._disposables.push({dispose:()=>{for(let t in this._listener)this._listener[t].dispose()}}),a.getModels().forEach(l)}dispose(){this._disposables.forEach(e=>e&&e.dispose()),this._disposables=[]}_doValidate(e,i){this._worker(e).then(o=>{var l;let u=((l=a.getModel(e))===null||l===void 0?void 0:l.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(u=this._defaults.preprocessCode(u)),o.doValidation(u)}).then(o=>{const l=o.map(t=>m(e,t));let u=a.getModel(e);u&&u.getLanguageId()===i&&a.setModelMarkers(u,i,l)}).then(void 0,o=>{console.error(o)})}}function M(s){switch(s){default:return w.Error}}function m(s,e){return{severity:M(),startLineNumber:e.startLine,startColumn:e.startColumn,endLineNumber:e.endLine,endColumn:e.endColumn,message:e.message,code:void 0,source:"dt-sql-parser"}}class y{constructor(e,i){this._worker=e,this._defaults=i}get triggerCharacters(){return Array.isArray(this._defaults.triggerCharacters)?this._defaults.triggerCharacters:["."," "]}provideCompletionItems(e,i,o,l){const u=e.uri;return this._worker(u).then(t=>{var r;let n=((r=a.getModel(u))===null||r===void 0?void 0:r.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(n=this._defaults.preprocessCode(n)),t.doCompletionWithEntities(n,i)}).then(([t,r])=>this._defaults.completionService(e,i,o,t,r)).then(t=>{const r=e.getWordUntilPosition(i),n=new v(i.lineNumber,r.startColumn,i.lineNumber,r.endColumn);return{suggestions:(Array.isArray(t)?t:t.suggestions).map(d=>{var p,g;return Object.assign(Object.assign({},d),{insertText:(p=d.insertText)!==null&&p!==void 0?p:typeof d.label=="string"?d.label:d.label.label,range:(g=d.range)!==null&&g!==void 0?g:n})}),dispose:Array.isArray(t)?void 0:t.dispose,incomplete:Array.isArray(t)?void 0:t.incomplete}})}}class I{constructor(e,i){this._worker=e,this._defaults=i}provideDefinition(e,i,o){const l=e.uri;return e.getLineContent(i.lineNumber).startsWith("--")?null:this._worker(l).then(t=>{let r=(e==null?void 0:e.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(r=this._defaults.preprocessCode(r)),t.getAllEntities(r)}).then(t=>{const r=e.getWordAtPosition(i);let n={line:-1,startIndex:-1,endIndex:-1,startColumn:-1,endColumn:-1};if(t==null||t.forEach(h=>{h.entityContextType.includes("Create")&&(r!=null&&r.word)&&h.text===(r==null?void 0:r.word)&&(n=h.position)}),n&&n.line!==-1)return{uri:e.uri,range:new v(n==null?void 0:n.line,n==null?void 0:n.startColumn,n==null?void 0:n.line,n==null?void 0:n.endColumn)}})}}class L{constructor(e,i){this._worker=e,this._defaults=i}provideReferences(e,i,o,l){const u=e.uri;if(e.getLineContent(i.lineNumber).startsWith("CREATE"))return this._worker(u).then(r=>{let n=(e==null?void 0:e.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(n=this._defaults.preprocessCode(n)),r.getAllEntities(e==null?void 0:e.getValue())}).then(r=>{const n=e.getWordAtPosition(i),h=[];return r==null||r.forEach(c=>{if(n!=null&&n.word&&c.text===(n==null?void 0:n.word)){let d=null;d=c.position,h.push({uri:e.uri,range:new v(d==null?void 0:d.line,d==null?void 0:d.startColumn,d==null?void 0:d.line,d==null?void 0:d.endColumn)})}}),h})}}function E(s){const e=[],i=[],o=new b(s);e.push(o);const l=(...t)=>o.getLanguageServiceWorker(...t);function u(){const{languageId:t,modeConfiguration:r}=s;C(i),r.diagnostics&&i.push(new A(t,l,s)),r.completionItems.enable&&i.push(f.registerCompletionItemProvider(t,new y(l,s))),r.references&&i.push(f.registerReferenceProvider(t,new L(l,s))),r.definitions&&i.push(f.registerDefinitionProvider(t,new I(l,s)))}return u(),e.push(_(i)),_(e)}function _(s){return{dispose:()=>C(s)}}function C(s){for(var e;s.length;)(e=s.pop())===null||e===void 0||e.dispose()}export{E as setupLanguageMode};
